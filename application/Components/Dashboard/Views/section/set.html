{*
 * Шаблон для изменения настроек заданного раздела
 *
 * @package   This file is part of the Kit.cms
 * @author    Anton Popov <a.popov@kit.team>
 * @copyright Kit.team <http://www.kit.team>
 * @link      Kit.cms <http://www.kitcms.ru>
 *}

{use 'component:site/add.html'}
{import 'component:section/add.html'}

{block 'component_set'}{parent}
{* Выборка данных *}
{if $.request.section ? && ($section = $.model->factory('Section')->findOne($.request.section))}
    {set $site = $section->site()->findOne()}
    {set $parents = $section->parents()->orderByAsc('path')->findMany()}
    {if $.request.apply !}
        {if $section->set($.request)->save()}
            {set $message}
            <div class="alert alert-success alert-dismissable">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                <span class="glyphicon glyphicon-ok"></span>
                Данные объекта успешно обновлены.
            </div>
            {/set}
        {else}
            {set $message}
            <div class="alert alert-danger alert-dismissable">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                <span class="glyphicon glyphicon-remove"></span>
                Не удалось сохранить изменения.
            </div>
            {/set}
        {/if}
    {/if}
{else}
    {exit}
{/if}

{var $.request = array_merge($.request, $section->asArray())}

{* Формирование меню *}
{set $menu.main.left.site.class="active"}
{set $menu.second = []}
{if ! $section->extension}
    {set $menu.second.left.section = [ 'title' => 'Разделы', 'link' => $.component ~ '/section/list.html?section=' ~ $.request.section]}
{/if}
{if $section->infobox.model ?}
    {set $menu.second.left.object = [ 'title' => 'Объекты', 'link' => $.component ~ '/row/list.html?section=' ~ $.request.section]}
{/if}
{set $menu.second.right = [
    [ 'title' => 'Изменение настроек', 'link' => $.component ~ '/section/set.html?section=' ~ $.request.section, 'class' => 'active' ],
    [ 'title' => 'Редактирование шаблона', 'link' => $.component ~ '/section/edit.html?section=' ~ $section.id ]
]}

{* Построение древовидного меню *}
{set $tree.open_nodes[] = 'site_' ~ $site->id}
{foreach $parents as $parent}
    {set $tree.open_nodes[] = 'section_' ~ $parent->id}
{/foreach}
{set $tree.open_nodes[] = 'section_' ~ $section->id}
{set $tree.selected_node[] = 'section_' ~ $section->id}

{set $additionals = $section->schema()->field()->whereNotIn('field', array_column($section->fields(), 'field'))->findMany()}
{set $templates = $.model->factory('Template')->orderByAsc('path')->findMany()}
{set $models = $.schema->findMany()}
{/block}

{block 'component_aside'}
<div id="tree" data-url="{$.component}/site/tree.html"></div>
{/block}

{block 'component_content'}
{parent}
<form id="set" action="{$.component}/section/set.html?section={$section.id}&apply" method="post">
    <ul class="nav nav-tabs">
        <li class="{if 'main' == $.cookie.tabs || ! $.cookie.tabs}active{/if}"><a href="#main" data-toggle="tab">Основная информация</a></li>
        <li class="{if 'meta' == $.cookie.tabs}active{/if}"><a href="#meta" data-toggle="tab">Метаинформация</a></li>
        {if $additionals ?}
            <li class="{if 'additional' == $.cookie.tabs}active{/if}"><a href="#additional" data-toggle="tab">Дополнительная информация</a></li>
        {/if}
        <li class="{if 'template' == $.cookie.tabs}active{/if}"><a href="#template" data-toggle="tab">Макет дизайна</a></li>
        <li class="{if 'infobox' == $.cookie.tabs}active{/if}"><a href="#infobox" data-toggle="tab">Инфобокс</a></li>
    </ul>
    <div class="tab-content">
        {macro.main}
        {macro.meta}
        {macro.template templates=$templates inherit=true}
        {macro.infobox models=$models}
    </div>
</form>
{/block}

{block 'component_footer'}
<input class="btn btn-default" type="submit" role="button" value="Сохранить изменения" form="set">
<div class="pull-right">
    <a class="btn btn-default" href="{$.component}/section/set.html?section={$section.id}" role="button">Отменить изменения</a>
</div>
{/block}
